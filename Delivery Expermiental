local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local isMoving = false
local targetYPosition = -60 -- Posición bajo el mapa
local currentDoor = nil
local previousItemDoor = nil

-- Desactivar asientos
for _, seat in pairs(workspace:GetDescendants()) do
    if seat:IsA("Seat") or seat:IsA("VehicleSeat") then
        seat.Disabled = true
    end
end

-- Evitar muerte por caída
RunService.Heartbeat:Connect(function()
    if humanoidRootPart.Position.Y < -50 then
        humanoidRootPart.Velocity = Vector3.zero
    end
end)

-- Función para teletransportarse suavemente
local function smoothTeleportToDoor(door)
    isMoving = true

    local currentPosition = humanoidRootPart.Position
    local belowCurrentPosition = Vector3.new(currentPosition.X, targetYPosition, currentPosition.Z)
    local belowDoorPosition = Vector3.new(door.Position.X, targetYPosition, door.Position.Z)
    local aboveDoorPosition = Vector3.new(door.Position.X, door.Position.Y + 5, door.Position.Z)

    -- Bajada rápida desde la posición actual (0 segundos)
    local tweenDown = TweenService:Create(humanoidRootPart, TweenInfo.new(0), {CFrame = CFrame.new(belowCurrentPosition)})
    tweenDown:Play()
    tweenDown.Completed:Wait()

    -- Movimiento por debajo hacia la puerta (5 segundos)
    local tweenMove = TweenService:Create(humanoidRootPart, TweenInfo.new(5), {CFrame = CFrame.new(belowDoorPosition)})
    tweenMove:Play()
    tweenMove.Completed:Wait()

    -- Subir a la puerta
    local tweenUp = TweenService:Create(humanoidRootPart, TweenInfo.new(0.2), {CFrame = CFrame.new(aboveDoorPosition)})
    tweenUp:Play()
    tweenUp.Completed:Wait()

    -- Bajar nuevamente debajo de la puerta (0.1 segundos)
    local tweenDownToFinal = TweenService:Create(humanoidRootPart, TweenInfo.new(0.1), {CFrame = CFrame.new(belowDoorPosition)})
    tweenDownToFinal:Play()
    tweenDownToFinal.Completed:Wait()

    -- Actualizar la puerta actual
    currentDoor = door

    isMoving = false
end

-- Detectar cuando se equipa una pizza/soda
character.ChildAdded:Connect(function(item)
    if item:FindFirstChild("House") and not isMoving then
        local house = item.House.Value
        local doors = house:GetDescendants()

        for _, door in ipairs(doors) do
            if door.Name == "GivePizza" then
                -- Verificar si es una nueva puerta
                if currentDoor ~= door then
                    smoothTeleportToDoor(door)
                end
                -- Actualizar la puerta previa asociada al item
                previousItemDoor = door
                break
            end
        end
    end
end)

-- Detectar si el jugador intenta entregar en otra puerta
RunService.Heartbeat:Connect(function()
    if previousItemDoor and currentDoor and previousItemDoor ~= currentDoor then
        smoothTeleportToDoor(previousItemDoor)
    end
end)

-- Detener el script al reiniciar
player.CharacterAdded:Connect(function()
    script:Destroy()
end)
