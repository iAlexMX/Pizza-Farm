local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local isMoving = false
local targetYPosition = -60 -- Posición bajo el mapa
local currentDoor = nil
local targetDoor = nil -- Puerta objetivo más reciente
local lastDoor = nil -- Última puerta visitada

-- Desactivar asientos
for _, seat in pairs(workspace:GetDescendants()) do
    if seat:IsA("Seat") or seat:IsA("VehicleSeat") then
        seat.Disabled = true
    end
end

-- Evitar muerte por caída
RunService.Heartbeat:Connect(function()
    if humanoidRootPart.Position.Y < -50 then
        humanoidRootPart.Velocity = Vector3.zero
    end
end)

-- Función para teletransportarse suavemente
local function smoothTeleportToDoor(door)
    if door == lastDoor then
        print("Ya se entregó en esta puerta. No se moverá.")
        return
    end

    isMoving = true

    local currentPosition = humanoidRootPart.Position
    local belowCurrentPosition = Vector3.new(currentPosition.X, targetYPosition, currentPosition.Z)
    local belowDoorPosition = Vector3.new(door.Position.X, targetYPosition, door.Position.Z)
    local aboveDoorPosition = Vector3.new(door.Position.X, door.Position.Y + 5, door.Position.Z)

    -- Bajada rápida desde la posición actual
    local tweenDown = TweenService:Create(humanoidRootPart, TweenInfo.new(0), {CFrame = CFrame.new(belowCurrentPosition)})
    tweenDown:Play()
    tweenDown.Completed:Wait()

    -- Movimiento por debajo hacia la puerta
    local tweenMove = TweenService:Create(humanoidRootPart, TweenInfo.new(2), {CFrame = CFrame.new(belowDoorPosition)})
    tweenMove:Play()
    tweenMove.Completed:Wait()

    -- Subir a la puerta
    local tweenUp = TweenService:Create(humanoidRootPart, TweenInfo.new(0.2), {CFrame = CFrame.new(aboveDoorPosition)})
    tweenUp:Play()
    tweenUp.Completed:Wait()

    -- Bajar nuevamente debajo de la puerta
    local tweenDownToFinal = TweenService:Create(humanoidRootPart, TweenInfo.new(0.1), {CFrame = CFrame.new(belowDoorPosition)})
    tweenDownToFinal:Play()
    tweenDownToFinal.Completed:Wait()

    -- Actualizar la última puerta visitada
    lastDoor = door

    -- Verificar si la puerta objetivo ha cambiado durante el movimiento
    if targetDoor and targetDoor ~= door then
        smoothTeleportToDoor(targetDoor) -- Moverse inmediatamente a la nueva puerta
    else
        isMoving = false
    end
end

-- Detectar cuando se equipa una pizza/soda
character.ChildAdded:Connect(function(item)
    if item:FindFirstChild("House") then
        local house = item.House.Value
        local doors = house:GetDescendants()

        for _, door in ipairs(doors) do
            if door.Name == "GivePizza" then
                -- Actualizar la puerta objetivo
                targetDoor = door

                -- Si ya está en movimiento, interrumpir para priorizar la nueva puerta
                if isMoving then
                    isMoving = false
                end

                -- Iniciar el movimiento hacia la nueva puerta
                smoothTeleportToDoor(targetDoor)
                break
            end
        end
    end
end)

-- Detener el script al reiniciar
player.CharacterAdded:Connect(function()
    script:Destroy()
end)
